@{
  ViewData["Title"] = "Dashboard";
}

<div class="container">
  <h1 class="mb-4">Dashboard de Coletas</h1>

  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-end">
        <div class="col-md-4">
          <label for="startDate" class="form-label">Data In√≠cio</label>
          <input type="date" class="form-control" id="startDate">
        </div>
        <div class="col-md-4">
          <label for="endDate" class="form-label">Data Fim</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-md-4">
          <button type="button" class="btn btn-primary" id="btnBuscar">
            Buscar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Total de Coletas</h6>
          <h2 class="card-title mb-3" id="totalCollects">-</h2>

          <div id="totalCollectsComparisonBox">
            <span id="totalCollectsArrow" style="font-size: 1.2rem;"></span>
            <span id="totalCollectsPercentage" style="font-weight: bold; font-size: 1.1rem;"></span>
            <p class="text-muted small mb-0 mt-1">
              vs <span id="totalCollectsComparison">-</span> (per√≠odo anterior)
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Volume Total (L)</h6>
          <h2 class="card-title mb-3" id="totalVolume">-</h2>

          <div id="totalVolumeComparisonBox">
            <span id="totalVolumeArrow" style="font-size: 1.2rem;"></span>
            <span id="totalVolumePercentage" style="font-weight: bold; font-size: 1.1rem;"></span>
            <p class="text-muted small mb-0 mt-1">
              vs <span id="totalVolumeComparison">-</span> (per√≠odo anterior)
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Peso Total (kg)</h6>
          <h2 class="card-title mb-3" id="totalWeight">-</h2>

          <div id="totalWeightComparisonBox">
            <span id="totalWeightArrow" style="font-size: 1.2rem;"></span>
            <span id="totalWeightPercentage" style="font-weight: bold; font-size: 1.1rem;"></span>
            <p class="text-muted small mb-0 mt-1">
              vs <span id="totalWeightComparison">-</span> (per√≠odo anterior)
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h6 class="card-subtitle mb-3 text-muted text-center">üè≠ Fornecedor Mais Coletado</h6>

          <div class="text-center mb-3">
            <h5 class="mb-1" id="topSupplierName">-</h5>
            <h3 class="text-primary mb-0" id="topSupplierCount">-</h3>
            <small class="text-muted">coletas</small>
          </div>

          <hr class="my-3">

          <div class="text-center text-muted small">
            <p class="mb-1"><strong>Per√≠odo anterior:</strong></p>
            <p class="mb-0">
              <span id="prevTopSupplierName">-</span>
              (<span id="prevTopSupplierCount">-</span> coletas)
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h6 class="card-subtitle mb-3 text-muted text-center">üì¶ Produto Mais Coletado</h6>

          <div class="text-center mb-3">
            <h5 class="mb-1" id="topProductName">-</h5>
            <h3 class="text-primary mb-0" id="topProductCount">-</h3>
            <small class="text-muted">coletas</small>
          </div>

          <hr class="my-3">

          <div class="text-center text-muted small">
            <p class="mb-1"><strong>Per√≠odo anterior:</strong></p>
            <p class="mb-0">
              <span id="prevTopProductName">-</span>
              (<span id="prevTopProductCount">-</span> coletas)
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h6 class="card-subtitle mb-3 text-muted text-center">üè¢ Filial Mais Coletada</h6>

          <div class="text-center mb-3">
            <h5 class="mb-1" id="topFilialName">-</h5>
            <h3 class="text-primary mb-0" id="topFilialCount">-</h3>
            <small class="text-muted">coletas</small>
          </div>

          <hr class="my-3">

          <div class="text-center text-muted small">
            <p class="mb-1"><strong>Per√≠odo anterior:</strong></p>
            <p class="mb-0">
              <span id="prevTopFilialName">-</span>
              (<span id="prevTopFilialCount">-</span> coletas)
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-5 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Coletas por Status</h5>
          <div style="max-width: 350px; margin: 0 auto;">
            <canvas id="chartStatus"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-7 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Coletas por Dia</h5>
          <canvas id="chartPerDay"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let chartStatus = null;
  let chartPerDay = null;

  function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function formatDateForDisplay(dateValue) {
    const date = typeof dateValue === 'string'
      ? new Date(dateValue.replace(/(\.\d{3})\d+/, '$1'))
      : new Date(dateValue);

    if (isNaN(date)) return '';

    return date.toLocaleDateString('pt-BR');
  }

  function formatNumber(num) {
    return new Intl.NumberFormat('pt-BR').format(num);
  }

  const today = new Date();
  const lastMonth = new Date();
  lastMonth.setMonth(lastMonth.getMonth() - 1);

  document.getElementById('startDate').value = formatDateForInput(lastMonth);
  document.getElementById('endDate').value = formatDateForInput(today);

  const statusMap = {
    0: 'Pendente Aprovar',
    1: 'Pendente Coletar',
    2: 'Coletado',
    3: 'Cancelado',
  };

  const statusColors = {
    'Pendente Aprovar': '#ffc107',
    'Pendente Coletar': '#fd7e14',
    'Coletado': '#28a745',
    'Cancelado': '#dc3545',
  };

  function renderComparison(currentValue, previousValue, elementPrefix) {
    const arrowElement = document.getElementById(elementPrefix + 'Arrow');
    const percentageElement = document.getElementById(elementPrefix + 'Percentage');
    const comparisonElement = document.getElementById(elementPrefix + 'Comparison');

    let percentage = 0;
    let arrow = '';
    let color = '';
    let sign = '';

    if (previousValue === 0) {
      if (currentValue === 0) {
        percentage = 0;
        arrow = '‚îÄ';
        color = '#6c757d';
        sign = '';
      } else {
        percentage = 100;
        arrow = '‚ñ≤';
        color = '#28a745';
        sign = '+';
      }
    } else {
      percentage = ((currentValue - previousValue) / previousValue) * 100;

      if (percentage > 0) {
        arrow = '‚ñ≤';
        color = '#28a745';
        sign = '+';
      } else if (percentage < 0) {
        arrow = '‚ñº';
        color = '#dc3545';
        sign = '';
      } else {
        arrow = '‚îÄ';
        color = '#6c757d';
        sign = '';
      }
    }

    arrowElement.textContent = arrow;
    arrowElement.style.color = color;

    percentageElement.textContent = sign + percentage.toFixed(1) + '%';
    percentageElement.style.color = color;

    comparisonElement.textContent = formatNumber(previousValue);
  }

  async function fetchDashboardData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
      alert('Por favor, selecione ambas as datas.');
      return;
    }

    try {
      const response = await fetch(`/Dashboard/GetData?startDate=${startDate}&endDate=${endDate}`);

      if (!response.ok) {
        throw new Error('Erro ao buscar dados');
      }

      const data = await response.json();
      updateDashboard(data);
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao carregar dados do dashboard');
    }
  }

  function updateDashboard(data) {
    document.getElementById('totalCollects').textContent = formatNumber(data.currentTotalCollects);
    document.getElementById('totalVolume').textContent = formatNumber(data.currentTotalVolume);
    document.getElementById('totalWeight').textContent = formatNumber(data.currentTotalWeight);

    renderComparison(data.currentTotalCollects, data.previousTotalCollects, 'totalCollects');
    renderComparison(data.currentTotalVolume, data.previousTotalVolume, 'totalVolume');
    renderComparison(data.currentTotalWeight, data.previousTotalWeight, 'totalWeight');

    document.getElementById('topSupplierName').textContent = data.currentTopSupplier.name || 'N/A';
    document.getElementById('topSupplierCount').textContent = formatNumber(data.currentTopSupplier.count);
    document.getElementById('prevTopSupplierName').textContent = data.previousTopSupplier.name || 'N/A';
    document.getElementById('prevTopSupplierCount').textContent = formatNumber(data.previousTopSupplier.count);

    document.getElementById('topProductName').textContent = data.currentTopProduct.name || 'N/A';
    document.getElementById('topProductCount').textContent = formatNumber(data.currentTopProduct.count);
    document.getElementById('prevTopProductName').textContent = data.previousTopProduct.name || 'N/A';
    document.getElementById('prevTopProductCount').textContent = formatNumber(data.previousTopProduct.count);

    document.getElementById('topFilialName').textContent = data.currentTopFilial.name || 'N/A';
    document.getElementById('topFilialCount').textContent = formatNumber(data.currentTopFilial.count);
    document.getElementById('prevTopFilialName').textContent = data.previousTopFilial.name || 'N/A';
    document.getElementById('prevTopFilialCount').textContent = formatNumber(data.previousTopFilial.count);

    updateChartStatus(data.collectPerStatusDto);
    updateChartPerDay(data.collectPerDayDto);
  }

  function updateChartStatus(statusData) {
    const ctx = document.getElementById('chartStatus');

    const labels = statusData.map(item => statusMap[item.status] || `Status ${item.status}`);
    const values = statusData.map(item => item.total);
    const colors = labels.map(label => statusColors[label] || '#6c757d');

    if (chartStatus) {
      chartStatus.data.labels = labels;
      chartStatus.data.datasets[0].data = values;
      chartStatus.data.datasets[0].backgroundColor = colors;
      chartStatus.update();
    } else {
      chartStatus = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
  }

  function updateChartPerDay(dayData) {
    const ctx = document.getElementById('chartPerDay');

    const sortedData = dayData.sort((a, b) => new Date(a.date) - new Date(b.date));
    const labels = sortedData.map(item => formatDateForDisplay(item.date));
    const values = sortedData.map(item => item.total);

    if (chartPerDay) {
      chartPerDay.data.labels = labels;
      chartPerDay.data.datasets[0].data = values;
      chartPerDay.update();
    } else {
      chartPerDay = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Coletas',
            data: values,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
  }

  document.getElementById('btnBuscar').addEventListener('click', fetchDashboardData);

  document.addEventListener('DOMContentLoaded', fetchDashboardData);
</script>

<style>
  #topSupplierName,
  #topProductName {
    font-weight: 600;
    color: #212529;
  }

  #topSupplierCount,
  #topProductCount {
    font-weight: 700;
  }
</style>